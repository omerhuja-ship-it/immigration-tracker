<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immigration Status Management - Synced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .task-card {
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .status-waiting { background-color: #FEF3C7; color: #92400E; }
        .status-in-progress { background-color: #DBEAFE; color: #1E40AF; }
        .status-completed { background-color: #D1FAE5; color: #065F46; }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sync-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="notification-container"></div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header with Sync Status -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Immigration Status Management</h1>
                    <p class="text-gray-600">Track all documents, tasks, and steps in the process</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex items-center gap-2 px-4 py-2 bg-green-50 border-2 border-green-200 rounded-lg">
                        <div class="w-3 h-3 rounded-full bg-green-500 sync-indicator"></div>
                        <span class="text-sm font-medium text-green-700" id="sync-status">Cloud Synced</span>
                    </div>
                    <div class="text-xs text-gray-500" id="last-update">Last update: Now</div>
                </div>
            </div>
            
            <!-- Share Section -->
            <div class="mt-4 p-4 bg-indigo-50 border-2 border-indigo-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-indigo-600 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800 mb-1">Share with your spouse</h3>
                        <p class="text-sm text-gray-600 mb-3">Both of you can access and update the same data in real-time. Just share this page URL!</p>
                        <div class="flex gap-2">
                            <input type="text" id="share-url" readonly value="" class="flex-1 px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm">
                            <button onclick="copyShareLink()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition">
                                Copy Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                    <span>Waiting</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-blue-400"></div>
                    <span>In Progress</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-green-400"></div>
                    <span>Completed</span>
                </div>
            </div>
        </div>

        <!-- Progress Overview -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Progress</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                    <div class="text-3xl font-bold text-green-600" id="completed-count">0</div>
                    <div class="text-gray-600">Tasks Completed</div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                    <div class="text-3xl font-bold text-blue-600" id="in-progress-count">0</div>
                    <div class="text-gray-600">Tasks In Progress</div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-200">
                    <div class="text-3xl font-bold text-yellow-600" id="waiting-count">0</div>
                    <div class="text-gray-600">Tasks Waiting</div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Tasks & Documents</h2>
                <button onclick="addTask()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    + Add Task
                </button>
            </div>
            <div id="tasks-container" class="space-y-4"></div>
        </div>

        <!-- Lawyer Notes -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Lawyer Notes & Updates</h2>
            <div class="mb-4">
                <textarea 
                    id="lawyer-notes" 
                    class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none resize-none"
                    rows="4"
                    placeholder="Add notes, updates, or information received from the lawyer..."
                    oninput="saveData()"
                ></textarea>
            </div>
        </div>

        <!-- Important Dates -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Important Dates</h2>
                <button onclick="addDate()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition">
                    + Add Date
                </button>
            </div>
            <div id="dates-container" class="space-y-3"></div>
        </div>

        <!-- Activity Log -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Recent Activity</h2>
            <div id="activity-log" class="space-y-2 max-h-64 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // Initialize data structure
        const STORAGE_KEY = 'immigration-tracker-shared';
        
        let appData = {
            tasks: [
                {
                    id: 1,
                    title: 'Marriage Certificate + Apostille (Georgia)',
                    status: 'completed',
                    category: 'Documents',
                    notes: 'Document received with Georgian apostille',
                    date: new Date().toISOString()
                },
                {
                    id: 2,
                    title: 'Birth Certificate + Apostille (Belarus)',
                    status: 'completed',
                    category: 'Documents',
                    notes: 'Document received with Belarusian apostille',
                    date: new Date().toISOString()
                },
                {
                    id: 3,
                    title: 'Hebrew Translation of Marriage Certificate',
                    status: 'waiting',
                    category: 'Translations',
                    notes: 'Must be translated by certified translator',
                    date: ''
                },
                {
                    id: 4,
                    title: 'Hebrew Translation of Birth Certificate',
                    status: 'waiting',
                    category: 'Translations',
                    notes: 'Must be translated by certified translator',
                    date: ''
                },
                {
                    id: 5,
                    title: 'Single/Divorce Certificate from Belarus',
                    status: 'waiting',
                    category: 'Documents',
                    notes: 'Certificate confirming no previous marriages',
                    date: ''
                },
                {
                    id: 6,
                    title: 'Valid Passport Copy',
                    status: 'waiting',
                    category: 'Documents',
                    notes: 'Belarusian or Georgian passport',
                    date: ''
                },
                {
                    id: 7,
                    title: 'Entry Visa Application Form',
                    status: 'waiting',
                    category: 'Forms',
                    notes: 'Fill out on Population Authority website',
                    date: ''
                },
                {
                    id: 8,
                    title: 'Passport Photos',
                    status: 'waiting',
                    category: 'Documents',
                    notes: '2 photos with white background',
                    date: ''
                },
                {
                    id: 9,
                    title: 'Lawyer Consultation',
                    status: 'in-progress',
                    category: 'Legal Advice',
                    notes: 'Ongoing process',
                    date: ''
                }
            ],
            lawyerNotes: '',
            importantDates: [
                {
                    id: 1,
                    date: '',
                    description: 'Submission deadline to Population Authority',
                    notes: ''
                }
            ],
            activityLog: []
        };

        // Cloud sync functions using window.storage API
        async function loadFromCloud() {
            try {
                const result = await window.storage.get(STORAGE_KEY, true);
                if (result && result.value) {
                    const cloudData = JSON.parse(result.value);
                    appData = cloudData;
                    showNotification('âœ“ Data loaded from cloud', 'success');
                    updateLastUpdateTime();
                }
            } catch (error) {
                console.log('No cloud data found, using default data');
            }
        }

        async function saveToCloud() {
            try {
                await window.storage.set(STORAGE_KEY, JSON.stringify(appData), true);
                updateSyncStatus('Synced', 'success');
                updateLastUpdateTime();
            } catch (error) {
                console.error('Error saving to cloud:', error);
                updateSyncStatus('Sync Error', 'error');
            }
        }

        function updateSyncStatus(message, type) {
            const statusEl = document.getElementById('sync-status');
            statusEl.textContent = message;
            
            const indicator = statusEl.previousElementSibling;
            if (type === 'success') {
                indicator.className = 'w-3 h-3 rounded-full bg-green-500 sync-indicator';
            } else if (type === 'error') {
                indicator.className = 'w-3 h-3 rounded-full bg-red-500';
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('last-update').textContent = `Last update: ${timeStr}`;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 
                           type === 'error' ? 'bg-red-50 border-red-200' : 
                           'bg-blue-50 border-blue-200';
            
            notification.innerHTML = `
                <div class="flex items-center gap-3 ${bgColor} border-2 rounded-lg p-3">
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Save data
        async function saveData() {
            appData.lawyerNotes = document.getElementById('lawyer-notes').value;
            await saveToCloud();
            updateCounts();
        }

        // Render all components
        function renderAll() {
            renderTasks();
            renderDates();
            renderActivityLog();
            document.getElementById('lawyer-notes').value = appData.lawyerNotes || '';
            updateCounts();
        }

        // Update progress counts
        function updateCounts() {
            const completed = appData.tasks.filter(t => t.status === 'completed').length;
            const inProgress = appData.tasks.filter(t => t.status === 'in-progress').length;
            const waiting = appData.tasks.filter(t => t.status === 'waiting').length;
            
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('in-progress-count').textContent = inProgress;
            document.getElementById('waiting-count').textContent = waiting;
        }

        // Activity log
        function addActivity(message) {
            const activity = {
                id: Date.now(),
                message: message,
                timestamp: new Date().toISOString()
            };
            
            appData.activityLog.unshift(activity);
            
            // Keep only last 20 activities
            if (appData.activityLog.length > 20) {
                appData.activityLog = appData.activityLog.slice(0, 20);
            }
            
            renderActivityLog();
        }

        function renderActivityLog() {
            const container = document.getElementById('activity-log');
            container.innerHTML = '';
            
            if (appData.activityLog.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm italic">No activity yet</p>';
                return;
            }
            
            appData.activityLog.slice(0, 10).forEach(activity => {
                const time = new Date(activity.timestamp);
                const timeStr = time.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const activityDiv = document.createElement('div');
                activityDiv.className = 'flex items-start gap-3 text-sm p-2 hover:bg-gray-50 rounded';
                activityDiv.innerHTML = `
                    <div class="text-gray-500 text-xs mt-0.5">${timeStr}</div>
                    <div class="text-gray-700">${activity.message}</div>
                `;
                container.appendChild(activityDiv);
            });
        }

        // Render tasks
        function renderTasks() {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';
            
            appData.tasks.forEach(task => {
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-card bg-gray-50 p-5 rounded-xl border-2 border-gray-200 fade-in';
                
                const statusClass = `status-${task.status}`;
                const statusText = {
                    'waiting': 'Waiting',
                    'in-progress': 'In Progress',
                    'completed': 'Completed'
                };
                
                taskDiv.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800 mb-1">${task.title}</h3>
                            <p class="text-sm text-gray-600 mb-2">${task.category}</p>
                            ${task.notes ? `<p class="text-sm text-gray-500 italic">${task.notes}</p>` : ''}
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                                ${statusText[task.status]}
                            </span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <select onchange="updateTaskStatus(${task.id}, this.value)" class="px-3 py-1 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                            <option value="waiting" ${task.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                            <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${task.status === 'completed' ? 'selected' : ''}>Completed</option>
                        </select>
                        <input type="text" placeholder="Add notes..." value="${task.notes || ''}" 
                            onchange="updateTaskNotes(${task.id}, this.value)"
                            class="flex-1 px-3 py-1 border-2 border-gray-300 rounded-lg text-sm focus:outline-none focus:border-indigo-500">
                        <button onclick="deleteTask(${task.id})" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm transition">
                            Delete
                        </button>
                    </div>
                `;
                
                container.appendChild(taskDiv);
            });
        }

        // Render important dates
        function renderDates() {
            const container = document.getElementById('dates-container');
            container.innerHTML = '';
            
            appData.importantDates.forEach(dateItem => {
                const dateDiv = document.createElement('div');
                dateDiv.className = 'bg-gray-50 p-4 rounded-lg border-2 border-gray-200';
                
                dateDiv.innerHTML = `
                    <div class="flex gap-3 items-start">
                        <input type="date" value="${dateItem.date || ''}" 
                            onchange="updateDate(${dateItem.id}, 'date', this.value)"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                        <input type="text" placeholder="Description..." value="${dateItem.description || ''}" 
                            onchange="updateDate(${dateItem.id}, 'description', this.value)"
                            class="flex-1 px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500">
                        <button onclick="deleteDate(${dateItem.id})" class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">
                            Delete
                        </button>
                    </div>
                `;
                
                container.appendChild(dateDiv);
            });
        }

        // Task functions
        function addTask() {
            const title = prompt('Task name:');
            if (title) {
                const newTask = {
                    id: Date.now(),
                    title: title,
                    status: 'waiting',
                    category: 'General',
                    notes: '',
                    date: ''
                };
                appData.tasks.push(newTask);
                addActivity(`Added task: ${title}`);
                saveData();
                renderAll();
                showNotification('Task added successfully', 'success');
            }
        }

        async function updateTaskStatus(id, status) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                const oldStatus = task.status;
                task.status = status;
                if (status === 'completed') {
                    task.date = new Date().toISOString();
                }
                addActivity(`Updated "${task.title}" from ${oldStatus} to ${status}`);
                await saveData();
                renderAll();
                showNotification('Status updated', 'success');
            }
        }

        async function updateTaskNotes(id, notes) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                task.notes = notes;
                await saveData();
            }
        }

        async function deleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                const task = appData.tasks.find(t => t.id === id);
                appData.tasks = appData.tasks.filter(t => t.id !== id);
                addActivity(`Deleted task: ${task.title}`);
                await saveData();
                renderAll();
                showNotification('Task deleted', 'success');
            }
        }

        // Date functions
        function addDate() {
            const newDate = {
                id: Date.now(),
                date: '',
                description: '',
                notes: ''
            };
            appData.importantDates.push(newDate);
            addActivity('Added new important date');
            saveData();
            renderAll();
            showNotification('Date added', 'success');
        }

        async function updateDate(id, field, value) {
            const dateItem = appData.importantDates.find(d => d.id === id);
            if (dateItem) {
                dateItem[field] = value;
                await saveData();
            }
        }

        async function deleteDate(id) {
            if (confirm('Are you sure you want to delete this date?')) {
                appData.importantDates = appData.importantDates.filter(d => d.id !== id);
                addActivity('Deleted an important date');
                await saveData();
                renderAll();
                showNotification('Date deleted', 'success');
            }
        }

        // Share link functionality
        function copyShareLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showNotification('Link copied to clipboard! Share it with your spouse.', 'success');
            });
        }

        // Set share URL
        document.getElementById('share-url').value = window.location.href;

        // Auto-refresh data every 10 seconds to check for updates
        setInterval(async () => {
            try {
                const result = await window.storage.get(STORAGE_KEY, true);
                if (result && result.value) {
                    const cloudData = JSON.parse(result.value);
                    // Check if data has changed
                    if (JSON.stringify(cloudData) !== JSON.stringify(appData)) {
                        appData = cloudData;
                        renderAll();
                        showNotification('Data updated from cloud', 'success');
                    }
                }
            } catch (error) {
                console.log('Error checking for updates:', error);
            }
        }, 10000);

        // Initialize on load
        async function initialize() {
            await loadFromCloud();
            renderAll();
            updateLastUpdateTime();
        }

        initialize();
    </script>
</body>
</html>
